@model DotNetBlueprint.Models.ProjectRequest

@{
    ViewData["Title"] = "Blueprint Studio";
}

<link rel="stylesheet" href="~/css/generator.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="generator-container fade-in">
    <div class="mb-3">
        <a asp-controller="Home" asp-action="Index" class="text-decoration-none" style="color: var(--text-muted); font-weight: 500;">
            <i class="bi bi-arrow-left me-1"></i> Back to Home
        </a>
    </div>
    <div class="premium-card">
        <h1 class="title-gradient text-center">Architectural Blueprint</h1>
        <p class="text-center text-muted mb-5">Select a refined architecture to jumpstart your next .NET project.</p>

        <form asp-action="Generate" method="post" id="genForm">
            <div class="row g-4 mb-5">
                <div class="col-md-7">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-cpu"></i></span>
                            <input asp-for="ProjectName" class="form-control" placeholder="e.g. MyAmazingApp" />
                        </div>
                        <span asp-validation-for="ProjectName" class="text-danger small"></span>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label class="form-label">Runtime Version</label>
                        <select asp-for="NetVersion" class="form-select">
                            <option value="6.0">.NET 6.0 (STS)</option>
                            <option value="7.0">.NET 7.0 (STS)</option>
                            <option value="8.0" selected>.NET 8.0 (LTS)</option>
                            <option value="9.0">.NET 9.0 (Current)</option>
                            <option value="10.0">.NET 10.0 (Preview)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label mb-3">Choose Your Architecture</label>
                <div class="arch-grid">
                    <!-- Layered -->
                    <div class="arch-card" onclick="selectArch('Layered', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-layers"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Layered</h4>
                        <p>Classic N-Tier separation (Core, Business, Data, Web).</p>
                    </div>

                    <!-- MVC -->
                    <div class="arch-card" onclick="selectArch('MVC', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-window-sidebar"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>MVC</h4>
                        <p>The industry standard Model-View-Controller pattern.</p>
                    </div>

                    <!-- Clean Architecture -->
                    <div class="arch-card selected" onclick="selectArch('CleanArchitecture', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-shield-check"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Clean Architecture</h4>
                        <p>Domain-centric design for high maintainability.</p>
                    </div>

                    <!-- MVVM -->
                    <div class="arch-card" onclick="selectArch('MVVM', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-aspect-ratio"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>MVVM</h4>
                        <p>Clean separation between UI and business logic.</p>
                    </div>

                    <!-- Microservices -->
                    <div class="arch-card" onclick="selectArch('Microservices', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-boxes"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Microservices</h4>
                        <p>Scalable, distributed system with independent services.</p>
                    </div>

                    <!-- Hexagonal -->
                    <div class="arch-card" onclick="selectArch('Hexagonal', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-hexagon"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Hexagonal</h4>
                        <p>Ports and Adapters for decoupling core logic from infra.</p>
                    </div>

                    <!-- CQRS -->
                    <div class="arch-card" onclick="selectArch('CQRS', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-arrow-left-right"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>CQRS</h4>
                        <p>Command Query Responsibility Segregation for complex apps.</p>
                    </div>
                </div>
                <input type="hidden" asp-for="Architecture" id="selectedArch" value="CleanArchitecture" />
            </div>

            <div class="mb-5">
                <label class="form-label d-block mb-3 fs-5 fw-800">
                    <i class="bi bi-database-fill me-2 text-primary"></i>Database Provider
                </label>
                <div class="db-grid">
                    <!-- SQL Server -->
                    <div class="db-card selected" onclick="selectDb('SqlServer', this)">
                        <div class="db-icon"><i class="bi bi-database-fill"></i></div>
                        <h5>SQL Server</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>

                    <!-- PostgreSQL -->
                    <div class="db-card" onclick="selectDb('PostgreSQL', this)">
                        <div class="db-icon"><i class="bi bi-database"></i></div>
                        <h5>PostgreSQL</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>

                    <!-- MySQL -->
                    <div class="db-card" onclick="selectDb('MySQL', this)">
                        <div class="db-icon"><i class="bi bi-database-add"></i></div>
                        <h5>MySQL</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>

                    <!-- SQLite -->
                    <div class="db-card" onclick="selectDb('SQLite', this)">
                        <div class="db-icon"><i class="bi bi-database-check"></i></div>
                        <h5>SQLite</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>
                </div>
                <input type="hidden" asp-for="Database" id="selectedDb" value="SqlServer" />
            </div>

            <button type="submit" class="btn-modern w-100 py-3 mt-2" style="font-size: 1.1rem; letter-spacing: 1px;">
                <span>FORGE ARCHITECTURE</span>
                <i class="bi bi-hammer ms-2"></i>
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">Forging Your Architecture...</p>
            <p class="text-muted small">Please wait while we assemble your blueprint.</p>
        </div>
    </div>

    <script>
        function selectArch(val, el) {
            document.querySelectorAll('.arch-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedArch').value = val;
        }

        function selectDb(val, el) {
            document.querySelectorAll('.db-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedDb').value = val;
        }

        document.getElementById('genForm').addEventListener('submit', function() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Clear existing cookie
            document.cookie = "fileDownload=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            
            // Check for cookie return every 500ms
            const checkCookie = setInterval(() => {
                if (document.cookie.split(';').some((item) => item.trim().startsWith('fileDownload='))) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    clearInterval(checkCookie);
                    // Clean up cookie
                    document.cookie = "fileDownload=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
                }
            }, 500);

            // Safety timeout (30 seconds)
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                clearInterval(checkCookie);
            }, 30000);
        });

        document.addEventListener('DOMContentLoaded', () => {
             // Architecture init
             const currentArch = document.getElementById('selectedArch').value;
             if(currentArch) {
                 const cards = document.querySelectorAll('.arch-card');
                 cards.forEach(c => {
                     if(c.getAttribute('onclick').includes("'" + currentArch + "'")) {
                         c.classList.add('selected');
                         c.click();
                     }
                 });
             }

             // Database init
             const currentDb = document.getElementById('selectedDb').value;
             if(currentDb) {
                 const dbCards = document.querySelectorAll('.db-card');
                 dbCards.forEach(c => {
                     if(c.getAttribute('onclick').includes("'" + currentDb + "'")) {
                         c.classList.add('selected');
                         c.click();
                     }
                 });
             }
        });
    </script>
}
