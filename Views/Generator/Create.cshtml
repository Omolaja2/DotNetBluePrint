@model DotNetBlueprint.Models.ProjectRequest

@{
    ViewData["Title"] = "Blueprint Studio";
}

<link rel="stylesheet" href="~/css/generator.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="generator-container fade-in">
    <div class="mb-3">
        <a asp-controller="Home" asp-action="Index" class="text-decoration-none" style="color: var(--text-muted); font-weight: 500;">
            <i class="bi bi-arrow-left me-1"></i> Back to Home
        </a>
    </div>
    <div class="premium-card">
        <h1 class="title-gradient text-center">Architectural Blueprint</h1>
        <p class="text-center text-muted mb-5">Select a refined architecture to jumpstart your next .NET project.</p>

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="premium-alert fade-in mb-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="alert-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    <div class="alert-content">
                        <h6 class="mb-1 fw-bold">Forge Advisory</h6>
                        <div asp-validation-summary="ModelOnly" class="small opacity-75"></div>
                    </div>
                </div>
            </div>
        }

        <form asp-action="Generate" method="post" id="genForm">


            <div class="row g-4 mb-5">
                <div class="col-md-7">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-cpu"></i></span>
                            <input asp-for="ProjectName" class="form-control" placeholder="e.g. MyAmazingApp" />
                        </div>
                        <span asp-validation-for="ProjectName" class="text-danger small"></span>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label class="form-label">Runtime Version</label>
                        <select asp-for="NetVersion" class="form-select">
                            <option value="6.0">.NET 6.0 (LTS Support)</option>
                            <option value="8.0" selected>.NET 8.0 (LTS)</option>
                            <option value="9.0">.NET 9.0 (Current)</option>
                            <option value="10.0">.NET 10.0 (Preview)</option>
                        </select>
                    </div>
                </div>

            </div>

            <div class="mb-4">
                <label class="form-label mb-3">Choose Your Architecture</label>
                <div class="arch-grid">
                    <!-- Layered -->
                    <div class="arch-card" onclick="selectArch('Layered', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-layers"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Layered</h4>
                        <p>Classic N-Tier separation (Core, Business, Data, Web).</p>
                    </div>

                    <!-- MVC -->
                    <div class="arch-card" onclick="selectArch('MVC', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-window-sidebar"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>MVC</h4>
                        <p>The industry standard Model-View-Controller pattern.</p>
                    </div>

                    <!-- Clean Architecture -->
                    <div class="arch-card selected" onclick="selectArch('CleanArchitecture', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-shield-check"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Clean Architecture</h4>
                        <p>Domain-centric design for high maintainability.</p>
                    </div>

                    <!-- MVVM -->
                    <div class="arch-card" onclick="selectArch('MVVM', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-aspect-ratio"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>MVVM</h4>
                        <p>Clean separation between UI and business logic.</p>
                    </div>

                    <!-- Microservices -->
                    <div class="arch-card" onclick="selectArch('Microservices', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-boxes"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Microservices</h4>
                        <p>Scalable, distributed system with independent services.</p>
                    </div>

                    <!-- Hexagonal -->
                    <div class="arch-card" onclick="selectArch('Hexagonal', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-hexagon"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>Hexagonal</h4>
                        <p>Ports and Adapters for decoupling core logic from infra.</p>
                    </div>

                    <!-- CQRS -->
                    <div class="arch-card" onclick="selectArch('CQRS', this)">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="arch-icon"><i class="bi bi-arrow-left-right"></i></div>
                            <div class="select-indicator"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                        <h4>CQRS</h4>
                        <p>Command Query Responsibility Segregation for complex apps.</p>
                    </div>
                </div>
                <input type="hidden" asp-for="Architecture" id="selectedArch" value="CleanArchitecture" />
            </div>

            <div class="mb-5">
                <label class="form-label d-block mb-3 fs-5 fw-800">
                    <i class="bi bi-database-fill me-2 text-primary"></i>Database Provider
                </label>
                <div class="db-grid">
                    <!-- SQL Server -->
                    <div class="db-card selected" onclick="selectDb('SqlServer', this)">
                        <div class="db-icon"><i class="bi bi-database-fill"></i></div>
                        <h5>SQL Server</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>

                    <!-- PostgreSQL -->
                    <div class="db-card" onclick="selectDb('PostgreSQL', this)">
                        <div class="db-icon"><i class="bi bi-database"></i></div>
                        <h5>PostgreSQL</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>

                    <!-- MySQL -->
                    <div class="db-card" onclick="selectDb('MySQL', this)">
                        <div class="db-icon"><i class="bi bi-database-add"></i></div>
                        <h5>MySQL</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>

                    <!-- SQLite -->
                    <div class="db-card" onclick="selectDb('SQLite', this)">
                        <div class="db-icon"><i class="bi bi-database-check"></i></div>
                        <h5>SQLite</h5>
                        <div class="ms-auto select-indicator sm"><i class="bi bi-check-circle-fill text-primary"></i></div>
                    </div>
                </div>
                <input type="hidden" asp-for="Database" id="selectedDb" value="SqlServer" />
            </div>

            <button type="submit" class="btn-modern w-100 py-3 mt-2" style="font-size: 1.1rem; letter-spacing: 1px;">
                <span>FORGE ARCHITECTURE</span>
                <i class="bi bi-hammer ms-2"></i>
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content" id="loadingContent">
            <div id="loadingSpinner" class="loading-spinner"></div>
            <div id="successIcon" class="success-icon" style="display: none;">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <p id="loadingStatus" class="loading-text">Forging Your Architecture...</p>
            <p id="loadingSubtext" class="text-muted small">Please wait while we assemble your blueprint.</p>
        </div>
    </div>

    <!-- Forge Error Modal -->
    <div id="errorModal" class="loading-overlay" style="display: none;">
        <div class="premium-card text-center" style="max-width: 450px; padding: 3rem;">
            <div class="text-danger mb-4" style="font-size: 4rem;">
                <i class="bi bi-exclamation-octagon-fill"></i>
            </div>
            <h3 class="fw-black mb-3 text-primary">Forge Interrupted</h3>
            <p class="text-muted mb-4 small">@Html.ValidationSummary(true)</p>
            <button type="button" class="btn-modern-outline w-100" onclick="document.getElementById('errorModal').style.display='none'">
                ACKNOWLEDGE
            </button>
        </div>
    </div>

    <style>
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1.5rem;
            animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @@keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        .loading-overlay.success-bg {
            background: rgba(255, 255, 255, 0.98);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // If there's a validation error, show the error modal automatically
            if ('@ViewData.ModelState.IsValid' === 'False') {
                document.getElementById('errorModal').style.display = 'flex';
            }
        });

        function selectArch(val, el) {

            document.querySelectorAll('.arch-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedArch').value = val;
        }

        function selectDb(val, el) {
            document.querySelectorAll('.db-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedDb').value = val;
        }

        document.getElementById('genForm').addEventListener('submit', function() {
            // Reset overlay state
            const overlay = document.getElementById('loadingOverlay');
            const spinner = document.getElementById('loadingSpinner');
            const success = document.getElementById('successIcon');
            const status = document.getElementById('loadingStatus');
            const subtext = document.getElementById('loadingSubtext');

            overlay.style.display = 'flex';
            overlay.classList.remove('success-bg');
            spinner.style.display = 'block';
            success.style.display = 'none';
            status.innerText = "Forging Your Architecture...";
            subtext.innerText = "Please wait while we assemble your blueprint.";

            // Clear existing cookie
            document.cookie = "fileDownload=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            
            // Check for cookie return every 500ms
            const checkCookie = setInterval(() => {
                if (document.cookie.split(';').some((item) => item.trim().startsWith('fileDownload='))) {
                    clearInterval(checkCookie);
                    
                    // Show "Generated" State
                    overlay.classList.add('success-bg');
                    spinner.style.display = 'none';
                    success.style.display = 'block';
                    status.innerText = "Generated!";
                    status.style.color = "#28a745";
                    subtext.innerText = "Your blueprint has been forged and downloaded.";

                    // Clean up cookie
                    document.cookie = "fileDownload=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";

                    // Hide after 2 seconds
                    setTimeout(() => {
                        fadeOut(overlay);
                    }, 2000);
                }
            }, 500);

            // Safety timeout (45 seconds)
            setTimeout(() => {
                if (overlay.style.display === 'flex' && spinner.style.display !== 'none') {
                    overlay.style.display = 'none';
                    clearInterval(checkCookie);
                }
            }, 45000);
        });

        function fadeOut(el) {
            el.style.opacity = 1;
            (function fade() {
                if ((el.style.opacity -= .1) < 0) {
                    el.style.display = "none";
                    el.style.opacity = 1;
                } else {
                    requestAnimationFrame(fade);
                }
            })();
        }


        document.addEventListener('DOMContentLoaded', () => {
             // Architecture init
             const currentArch = document.getElementById('selectedArch').value;
             if(currentArch) {
                 const cards = document.querySelectorAll('.arch-card');
                 cards.forEach(c => {
                     if(c.getAttribute('onclick').includes("'" + currentArch + "'")) {
                         c.classList.add('selected');
                         c.click();
                     }
                 });
             }

             // Database init
             const currentDb = document.getElementById('selectedDb').value;
             if(currentDb) {
                 const dbCards = document.querySelectorAll('.db-card');
                 dbCards.forEach(c => {
                     if(c.getAttribute('onclick').includes("'" + currentDb + "'")) {
                         c.classList.add('selected');
                         c.click();
                     }
                 });
             }
        });
    </script>
}
